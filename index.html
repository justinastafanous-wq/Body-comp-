<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5a4" />
  <title>Body Projection</title>
  <style>
    :root{
      --bg1:#f4fffd;
      --bg2:#f2f8ff;
      --card: rgba(255,255,255,.78);
      --card2: rgba(255,255,255,.62);
      --border: rgba(9,72,71,.14);
      --text:#0b1f1e;
      --muted: rgba(11,31,30,.65);
      --accent:#0ea5a4;       /* teal */
      --accent2:#22c55e;      /* green */
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 10px 30px rgba(2, 44, 43, .10);
      color-scheme: light;
    }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 5%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(900px 600px at 85% 10%, rgba(14,165,164,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: 18px;
    }

    .wrap{ max-width: 980px; margin:0 auto; }
    .hero{
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 14px 14px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.62));
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute;
      inset:-40px -40px auto auto;
      width:280px; height:280px;
      background: radial-gradient(circle at 30% 30%, rgba(14,165,164,.22), transparent 62%);
      transform: rotate(12deg);
    }
    h1{ margin:0; font-size: 20px; letter-spacing:.2px; }
    .subtitle{ margin-top: 6px; font-size: 12px; color: var(--muted); line-height:1.35; max-width: 70ch; }
    .bigline{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items: center;
      position: relative;
      z-index: 1;
    }
    .chip{
      border:1px solid var(--border);
      background: rgba(255,255,255,.6);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .chip b{ color: var(--text); }
    .card{
      margin-top: 14px;
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      background: var(--card);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    @media (max-width: 760px){ .grid{ grid-template-columns: 1fr; } }

    label{ display:block; font-size: 12px; color: var(--muted); margin: 0 0 6px; }
    input, select{
      width:100%;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(9,72,71,.18);
      background: rgba(255,255,255,.72);
      font-size: 16px;
      color: var(--text);
      outline: none;
    }
    input:focus, select:focus{
      border-color: rgba(14,165,164,.55);
      box-shadow: 0 0 0 4px rgba(14,165,164,.12);
    }

    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }

    .btnrow{ display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap; }
    button{
      border:none;
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
    }
    .primary{
      color:white;
      background: linear-gradient(135deg, var(--accent), rgba(34,197,94,.95));
      box-shadow: 0 10px 20px rgba(14,165,164,.22);
    }
    .secondary{
      color: var(--text);
      background: rgba(255,255,255,.75);
      border:1px solid var(--border);
      font-weight: 700;
    }
    .ghost{
      color: var(--text);
      background: rgba(255,255,255,.55);
      border:1px solid rgba(9,72,71,.10);
      font-weight: 800;
    }

    .tiny{ font-size: 11px; color: var(--muted); margin-top: 6px; line-height:1.35; }
    .muted{ font-size: 12px; color: var(--muted); line-height:1.4; }

    .results{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 900px){ .results{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.66);
      border-radius: 16px;
      padding: 12px;
    }
    .pill .k{ font-size: 12px; color: var(--muted); }
    .pill .v{ font-size: 18px; font-weight: 900; margin-top: 5px; letter-spacing:.2px; }

    .notice{
      margin-top: 10px;
      border-left: 4px solid var(--warn);
      background: rgba(245,158,11,.10);
      border-radius: 12px;
      padding: 10px 12px;
      color: rgba(11,31,30,.92);
      font-size: 13px;
      line-height:1.35;
    }
    .notice.bad{
      border-left-color: var(--bad);
      background: rgba(239,68,68,.10);
    }

    .presetRow{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .preset{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.70);
      font-size: 12px;
      font-weight: 800;
      color: rgba(11,31,30,.86);
    }

    canvas{
      width:100%;
      height: 260px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.62);
    }

    table{ width:100%; border-collapse: collapse; margin-top: 10px; overflow:hidden; border-radius: 16px; }
    th, td{ text-align:left; padding: 10px; border-bottom: 1px solid rgba(9,72,71,.10); font-size: 14px; }
    th{ font-size: 12px; color: var(--muted); }
    tr:last-child td{ border-bottom: none; }

    .hr{ height:1px; background: rgba(9,72,71,.12); margin: 10px 0; border-radius: 999px; }

    .miniCard{
      border:1px solid rgba(9,72,71,.12);
      background: rgba(255,255,255,.60);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
    }
    .checklist{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
      margin-top: 8px;
    }
    @media (max-width: 760px){ .checklist{ grid-template-columns: 1fr; } }
    .checkItem{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid rgba(9,72,71,.10);
      background: rgba(255,255,255,.60);
      border-radius: 14px;
      padding: 10px 10px;
      font-size: 13px;
      color: rgba(11,31,30,.92);
    }
    .checkItem input{ width:18px; height:18px; margin-top:2px; }
    .checkItem .meta{ color: var(--muted); font-size: 12px; margin-top: 2px; line-height:1.25; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1>Body Projection</h1>
      <div class="subtitle">
        Projections are estimates. Scale weight can swing from water/glycogen—use this for direction and motivation, not perfection.
      </div>
      <div class="bigline">
        <div class="chip">Mode: <b id="heroMode">Daily Deficit</b></div>
        <div class="chip">Horizon: <b id="heroHorizon">56 days</b></div>
        <div class="chip">Adherence: <b id="heroAdh">100%</b></div>
        <div class="chip">Projected end: <b id="heroMsg">—</b></div>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label>Mode</label>
          <select id="mode">
            <option value="deficit" selected>Daily Deficit</option>
            <option value="calories">Target Calories (intake)</option>
            <option value="date">Target Date (goal weight by date)</option>
            <option value="goaleta">Goal Weight ETA (when will I hit it?)</option>
          </select>
          <div class="tiny">Goal modes use your Goal Weight (and Date) to compute either required deficit or ETA.</div>
        </div>

        <div>
          <label>Units</label>
          <select id="units">
            <option value="imperial" selected>Imperial (ft/in, lb)</option>
            <option value="metric">Metric (cm, kg)</option>
          </select>
        </div>

        <div>
          <label>Sex</label>
          <select id="sex">
            <option value="male" selected>Male</option>
            <option value="female">Female</option>
          </select>
        </div>

        <div>
          <label>Age</label>
          <input id="age" type="number" inputmode="numeric" min="10" max="100" value="33" />
        </div>

        <div id="heightImperial">
          <label>Height</label>
          <div class="row">
            <input id="ft" type="number" inputmode="numeric" min="3" max="8" value="5" />
            <input id="inch" type="number" inputmode="numeric" min="0" max="11" value="9" />
          </div>
          <div class="tiny">Feet / Inches</div>
        </div>

        <div id="heightMetric" style="display:none;">
          <label>Height (cm)</label>
          <input id="cm" type="number" inputmode="decimal" min="120" max="230" value="175" />
        </div>

        <div id="weightImperial">
          <label>Current weight (lb)</label>
          <input id="lb" type="number" inputmode="decimal" min="70" max="600" value="169" />
        </div>

        <div id="weightMetric" style="display:none;">
          <label>Current weight (kg)</label>
          <input id="kg" type="number" inputmode="decimal" min="30" max="300" value="76.7" />
        </div>

        <div>
          <label>Activity level</label>
          <select id="activity">
            <option value="1.2">Sedentary (little exercise)</option>
            <option value="1.375">Light (1–3 days/wk)</option>
            <option value="1.55" selected>Moderate (3–5 days/wk)</option>
            <option value="1.725">Very active (6–7 days/wk)</option>
            <option value="1.9">Athlete / extra active</option>
          </select>
        </div>

        <div>
          <label>Adherence</label>
          <input id="adherence" type="range" min="70" max="100" value="100" />
          <div class="tiny">Assumes you hit your plan <b id="adhLabel">100%</b> of the time.</div>
        </div>

        <div>
          <label>Horizon (days)</label>
          <input id="days" type="range" min="7" max="365" value="56" />
          <div class="tiny">Projecting <b id="daysLabel">56</b> days (~<b id="weeksLabel">8</b> weeks)</div>
          <div class="presetRow">
            <button class="preset" type="button" data-days="7">7</button>
            <button class="preset" type="button" data-days="14">14</button>
            <button class="preset" type="button" data-days="30">30</button>
            <button class="preset" type="button" data-days="60">60</button>
            <button class="preset" type="button" data-days="90">90</button>
          </div>
        </div>

        <div>
          <label>Maintenance / Refeed days</label>
          <select id="maintDays">
            <option value="0" selected>0 days/week (straight cut)</option>
            <option value="1">1 day/week (maintenance)</option>
            <option value="2">2 days/week (maintenance)</option>
          </select>
          <div class="tiny">These days assume ~0 deficit (maintenance), which slows weekly loss a bit but helps adherence.</div>
        </div>

        <div>
          <label>Maintenance days occur on</label>
          <select id="maintPattern">
            <option value="weekend" selected>Weekend (Sat/Sun first)</option>
            <option value="even">Evenly spaced</option>
          </select>
          <div class="tiny">Weekend is the most common schedule.</div>
        </div>

        <div>
          <label>Adaptation (optional)</label>
          <select id="adapt">
            <option value="0" selected>None (simple)</option>
            <option value="0.10">Mild (10% slower over time)</option>
            <option value="0.20">Moderate (20% slower over time)</option>
          </select>
        </div>

        <div>
          <label>Energy density</label>
          <select id="kcalPerLb">
            <option value="3500" selected>3,500 kcal per lb (standard)</option>
            <option value="3200">3,200 kcal per lb (slightly faster)</option>
            <option value="3700">3,700 kcal per lb (slightly slower)</option>
          </select>
        </div>

        <!-- Mode-specific inputs -->
        <div id="deficitBox">
          <label>Daily calorie deficit</label>
          <input id="deficit" type="number" inputmode="numeric" min="0" max="2000" value="500" />
          <div class="tiny">Rough rule: 500/day ≈ ~1 lb/week (varies).</div>
        </div>

        <div id="caloriesBox" style="display:none;">
          <label>Target calories (intake)</label>
          <input id="intake" type="number" inputmode="numeric" min="800" max="6000" value="2000" />
          <div class="tiny">We compute deficit = TDEE − intake (capped at 0).</div>
        </div>

        <div id="goalBox" style="display:none;">
          <label>Goal weight</label>
          <input id="goalWeight" type="number" inputmode="decimal" min="40" max="600" value="160" />
          <div class="tiny">Use lb if Imperial, kg if Metric.</div>
        </div>

        <div id="dateBox" style="display:none;">
          <label>Goal date</label>
          <input id="goalDate" type="date" />
          <div class="tiny">Target Date mode computes the required deficit to hit the goal by the date.</div>
        </div>
      </div>

      <div class="btnrow">
        <button class="primary" id="calc" type="button">Calculate</button>
        <button class="ghost" id="logToday" type="button">Log today</button>
        <button class="ghost" id="share" type="button">Share</button>
        <button class="secondary" id="reset" type="button">Reset</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        BMR: Mifflin–St Jeor. TDEE: activity multiplier. Not medical advice.
      </div>
    </div>

    <div class="card">
      <div class="results">
        <div class="pill">
          <div class="k">Estimated BMR</div>
          <div class="v" id="bmr">—</div>
          <div class="tiny">kcal/day</div>
        </div>
        <div class="pill">
          <div class="k">Estimated TDEE</div>
          <div class="v" id="tdee">—</div>
          <div class="tiny">kcal/day (maintenance)</div>
        </div>
        <div class="pill">
          <div class="k">Effective deficit</div>
          <div class="v" id="effDef">—</div>
          <div class="tiny">kcal/day after adherence + maintenance days</div>
        </div>
        <div class="pill">
          <div class="k">Expected rate</div>
          <div class="v" id="rate">—</div>
          <div class="tiny">per week (estimate)</div>
        </div>
      </div>

      <div id="checkpointBox" class="miniCard" style="display:none;"></div>
      <div id="notices"></div>

      <div class="hr"></div>

      <canvas id="chart" width="980" height="380"></canvas>
      <div class="tiny" style="margin-top:6px;">Chart is projected scale weight by week. (If goal mode is on, the goal line is shown.)</div>

      <table>
        <thead>
          <tr>
            <th>Week</th>
            <th>Projected weight</th>
            <th>Change</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="miniCard">
        <div style="font-weight:900; letter-spacing:.2px;">Logs (your real weigh-ins)</div>
        <div class="tiny">Tap “Log today” to save your current weight. Logs are stored on your phone (local storage).</div>
        <div id="logsView" class="tiny" style="margin-top:8px;">No logs yet.</div>
        <div class="btnrow" style="margin-top:10px;">
          <button class="secondary" id="clearLogs" type="button">Clear logs</button>
        </div>
      </div>

      <div class="miniCard">
        <div style="font-weight:900; letter-spacing:.2px;">Diet checklist (optional)</div>
        <div class="tiny">This is a planning checklist—not medical advice. If you have conditions/meds, run diet changes by a clinician.</div>

        <div class="grid" style="margin-top:8px;">
          <div>
            <label>Preset</label>
            <select id="dietPreset">
              <option value="none" selected>None</option>
              <option value="lowfodmap">Low FODMAP (starter)</option>
              <option value="diabetes">Diabetes-friendly basics</option>
              <option value="heart">Heart-healthy basics</option>
            </select>
          </div>
          <div>
            <label>Show checklist</label>
            <select id="dietShow">
              <option value="yes" selected>Yes</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>

        <div id="dietChecklist" class="checklist"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  function round(n, d=0){ const p=Math.pow(10,d); return Math.round(n*p)/p; }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function lbToKg(lb){ return lb * 0.45359237; }
  function kgToLb(kg){ return kg / 0.45359237; }
  function inToCm(inches){ return inches * 2.54; }
  function cmToIn(cm){ return cm / 2.54; }

  function mifflinStJeor({sex, kg, cm, age}){
    const s = (sex === "male") ? 5 : -161;
    return (10*kg) + (6.25*cm) - (5*age) + s;
  }

  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }

  // ---------- UI helpers ----------
  function setModeUI(){
    const mode = $("mode").value;
    $("deficitBox").style.display = (mode==="deficit") ? "" : "none";
    $("caloriesBox").style.display = (mode==="calories") ? "" : "none";
    $("goalBox").style.display = (mode==="date" || mode==="goaleta") ? "" : "none";
    $("dateBox").style.display = (mode==="date") ? "" : "none";

    $("heroMode").textContent =
      mode==="deficit" ? "Daily Deficit" :
      mode==="calories" ? "Target Calories" :
      mode==="date" ? "Target Date" : "Goal Weight ETA";
  }

  function setUnitUI(){
    const u = $("units").value;
    $("heightImperial").style.display = (u==="imperial") ? "" : "none";
    $("weightImperial").style.display = (u==="imperial") ? "" : "none";
    $("heightMetric").style.display   = (u==="metric") ? "" : "none";
    $("weightMetric").style.display   = (u==="metric") ? "" : "none";
  }

  function setHorizonLabels(){
    const d = Number($("days").value);
    $("daysLabel").textContent = d;
    $("weeksLabel").textContent = round(d/7, 1);
    $("heroHorizon").textContent = `${d} days`;
  }

  function setAdhLabel(){
    const a = Number($("adherence").value);
    $("adhLabel").textContent = `${a}%`;
    $("heroAdh").textContent = `${a}%`;
  }

  // ---------- Storage ----------
  const STORE_KEY = "bp_app_v3";
  function loadStore(){
    try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }catch(e){ return {}; }
  }
  function saveStore(obj){
    localStorage.setItem(STORE_KEY, JSON.stringify(obj));
  }

  function getInputs(){
    const units = $("units").value;
    const sex = $("sex").value;
    const age = Number($("age").value);
    const activity = Number($("activity").value);
    const mode = $("mode").value;

    const days = Number($("days").value);
    const adapt = Number($("adapt").value);
    const kcalPerLb = Number($("kcalPerLb").value);
    const adherence = Number($("adherence").value) / 100;

    const maintDays = Number($("maintDays").value);
    const maintPattern = $("maintPattern").value;

    let cm, kg;
    if(units === "imperial"){
      const ft = Number($("ft").value);
      const inch = Number($("inch").value);
      const lb = Number($("lb").value);
      const totalIn = (ft*12) + inch;
      cm = inToCm(totalIn);
      kg = lbToKg(lb);
    } else {
      cm = Number($("cm").value);
      kg = Number($("kg").value);
    }

    const deficit = Number($("deficit").value);
    const intake = Number($("intake").value);

    const goalWeight = Number($("goalWeight").value);
    const goalDate = $("goalDate").value;

    return { units, sex, age, activity, mode, days, adapt, kcalPerLb, adherence, maintDays, maintPattern,
             cm, kg, deficit, intake, goalWeight, goalDate };
  }

  function validate(x){
    const errs = [];
    if(!Number.isFinite(x.age) || x.age < 10 || x.age > 100) errs.push("Age looks off.");
    if(!Number.isFinite(x.cm) || x.cm < 120 || x.cm > 230) errs.push("Height looks off.");
    if(!Number.isFinite(x.kg) || x.kg < 30 || x.kg > 300) errs.push("Weight looks off.");
    if(!Number.isFinite(x.activity) || x.activity < 1.1 || x.activity > 2.2) errs.push("Activity looks off.");
    if(!Number.isFinite(x.days) || x.days < 7 || x.days > 365) errs.push("Horizon looks off.");
    if(x.mode==="deficit" && (!Number.isFinite(x.deficit) || x.deficit < 0 || x.deficit > 3000)) errs.push("Deficit looks off.");
    if(x.mode==="calories" && (!Number.isFinite(x.intake) || x.intake < 800 || x.intake > 8000)) errs.push("Intake looks off.");
    if((x.mode==="date" || x.mode==="goaleta")){
      if(!Number.isFinite(x.goalWeight)) errs.push("Goal weight looks off.");
      if(x.units==="imperial" && (x.goalWeight < 40 || x.goalWeight > 600)) errs.push("Goal weight looks off.");
      if(x.units==="metric" && (x.goalWeight < 20 || x.goalWeight > 300)) errs.push("Goal weight looks off.");
    }
    if(x.mode==="date"){
      if(!x.goalDate) errs.push("Pick a goal date.");
      else{
        const t = new Date(x.goalDate + "T00:00:00");
        const now = new Date();
        if(t <= now) errs.push("Goal date must be in the future.");
      }
    }
    return errs;
  }

  function renderNotices(list){
    const box = $("notices");
    box.innerHTML = "";
    for(const n of list){
      const div = document.createElement("div");
      div.className = "notice" + (n.type==="bad" ? " bad" : "");
      div.textContent = n.msg;
      box.appendChild(div);
    }
  }

  // ---------- Maintenance day scheduling ----------
  function makeMaintenanceSet(maintDays, pattern){
    // returns Set of day-of-week indices (0=Sun..6=Sat) for maintenance
    // Weekend: Sat/Sun first. Even: spaced.
    const set = new Set();
    if(maintDays <= 0) return set;
    if(pattern === "weekend"){
      // Prefer Sat & Sun
      if(maintDays >= 1) set.add(6); // Sat
      if(maintDays >= 2) set.add(0); // Sun
      return set;
    }
    // Evenly spaced: 1 day -> midweek (Wed). 2 days -> Wed + Sun.
    if(maintDays === 1) { set.add(3); return set; } // Wed
    if(maintDays === 2) { set.add(3); set.add(0); return set; }
    return set;
  }

  // ---------- Projection ----------
  function projectDailyWeightsKg({startKg, baseDef, adherence, days, adapt, kcalPerLb, maintDays, maintPattern}){
    const arr = [];
    let kg = startKg;
    arr.push(kg);

    const maintSet = makeMaintenanceSet(maintDays, maintPattern);

    const startDate = new Date(); // today
    for(let d=1; d<=days; d++){
      const progress = d / days;            // 0..1
      const adaptFactor = 1 - (adapt * progress); // 1 -> (1-adapt)

      const date = new Date(startDate.getTime());
      date.setDate(startDate.getDate() + (d-1));
      const dow = date.getDay(); // 0..6

      // If maintenance day, deficit is 0
      const dayDef = maintSet.has(dow) ? 0 : baseDef;

      // Apply adherence + adaptation
      const effDef = dayDef * adherence * adaptFactor;

      const lbChange = (effDef / kcalPerLb); // lb/day
      const kgChange = lbToKg(lbChange);
      kg = Math.max(0, kg - kgChange);
      arr.push(kg);
    }
    return arr;
  }

  function renderTable(weightsKgByDay, units){
    const tbody = $("tbody");
    tbody.innerHTML = "";
    const start = weightsKgByDay[0];
    const totalWeeks = Math.floor((weightsKgByDay.length-1)/7);

    for(let w=0; w<=totalWeeks; w++){
      const idx = Math.min(weightsKgByDay.length-1, w*7);
      const kg = weightsKgByDay[idx];
      const val = (units==="imperial") ? kgToLb(kg) : kg;
      const delta = (units==="imperial") ? kgToLb(kg - start) : (kg - start);

      const tr = document.createElement("tr");
      const tdW = document.createElement("td");
      const tdP = document.createElement("td");
      const tdD = document.createElement("td");

      tdW.textContent = String(w);
      tdP.textContent = (units==="imperial") ? `${round(val, 1)} lb` : `${round(val, 1)} kg`;
      const sign = delta >= 0 ? "+" : "";
      tdD.textContent = (units==="imperial") ? `${sign}${round(delta, 1)} lb` : `${sign}${round(delta, 1)} kg`;

      tr.appendChild(tdW); tr.appendChild(tdP); tr.appendChild(tdD);
      tbody.appendChild(tr);
    }
  }

  function drawChart(weightsKgByDay, units, goalLine){
    const c = $("chart");
    const ctx = c.getContext("2d");
    const W = c.width, H = c.height;
    ctx.clearRect(0,0,W,H);

    // sample weekly points for clarity
    const pts = [];
    for(let i=0;i<weightsKgByDay.length;i+=7) pts.push(weightsKgByDay[i]);
    if(pts[pts.length-1] !== weightsKgByDay[weightsKgByDay.length-1]) pts.push(weightsKgByDay[weightsKgByDay.length-1]);

    const padL=54, padR=18, padT=18, padB=44;

    const vals = pts.map(kg => units==="imperial" ? kgToLb(kg) : kg);
    const min = Math.min(...vals), max = Math.max(...vals);
    const span = Math.max(1e-9, max - min);
    const yMin = min - span*0.12;
    const yMax = max + span*0.12;

    // grid
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(9,72,71,.10)";
    ctx.fillStyle = "rgba(11,31,30,.55)";
    ctx.font = "12px -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial";

    const ticks = 5;
    for(let i=0;i<=ticks;i++){
      const t=i/ticks;
      const y = padT + (H-padT-padB)*(1-t);
      ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W-padR, y); ctx.stroke();

      const val = yMin + (yMax-yMin)*t;
      const label = round(val, units==="imperial" ? 0 : 1);
      ctx.fillText(String(label), 10, y+4);
    }

    // goal line
    if(goalLine != null){
      const gy = padT + (H-padT-padB)*(1 - ((goalLine-yMin)/(yMax-yMin)));
      ctx.setLineDash([6,6]);
      ctx.strokeStyle = "rgba(34,197,94,.65)";
      ctx.beginPath(); ctx.moveTo(padL, gy); ctx.lineTo(W-padR, gy); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = "rgba(34,197,94,.85)";
      ctx.fillText("Goal", padL+6, gy-6);
    }

    // line gradient
    const grad = ctx.createLinearGradient(padL, padT, W-padR, H-padB);
    grad.addColorStop(0, "rgba(14,165,164,.95)");
    grad.addColorStop(1, "rgba(34,197,94,.95)");

    ctx.lineWidth = 4;
    ctx.strokeStyle = grad;
    ctx.beginPath();
    for(let i=0;i<vals.length;i++){
      const x = padL + (W-padL-padR) * (i/(vals.length-1));
      const y = padT + (H-padT-padB) * (1 - ((vals[i]-yMin)/(yMax-yMin)));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    ctx.fillStyle = "rgba(14,165,164,.95)";
    for(let i=0;i<vals.length;i++){
      const x = padL + (W-padL-padR) * (i/(vals.length-1));
      const y = padT + (H-padT-padB) * (1 - ((vals[i]-yMin)/(yMax-yMin)));
      ctx.beginPath(); ctx.arc(x,y,3.6,0,Math.PI*2); ctx.fill();
    }

    // x labels
    ctx.fillStyle = "rgba(11,31,30,.55)";
    const step = Math.max(1, Math.round((vals.length-1)/6));
    for(let i=0;i<vals.length;i+=step){
      const x = padL + (W-padL-padR) * (i/(vals.length-1));
      ctx.fillText("W"+i, x-10, H-18);
    }

    const u = units==="imperial" ? "lb" : "kg";
    ctx.fillText("Projected weight ("+u+")", padL, 14);
  }

  // ---------- Checkpoints ----------
  function computeCheckpoints({units, startKg, goalKg}){
    // milestones every 5 lb or 2.5 kg, descending
    const start = units==="imperial" ? kgToLb(startKg) : startKg;
    const goal  = units==="imperial" ? kgToLb(goalKg) : goalKg;
    const step = units==="imperial" ? 5 : 2.5;

    if(goal >= start) return {next:null, list:[]};

    const list = [];
    let cur = Math.floor(start/step)*step;
    // ensure start included-ish
    while(cur > goal){
      list.push(cur);
      cur -= step;
    }
    list.push(goal);
    return {next: list.find(x => x < start) ?? null, list};
  }

  function updateCheckpointBox({units, startKg, goalKg, weightsKgByDay}){
    const box = $("checkpointBox");

    if(!goalKg || goalKg >= startKg){
      box.style.display = "none";
      return;
    }

    const startVal = (units==="imperial") ? kgToLb(startKg) : startKg;
    const goalVal  = (units==="imperial") ? kgToLb(goalKg) : goalKg;
    const unitLabel = (units==="imperial") ? "lb" : "kg";

    const cps = computeCheckpoints({units, startKg, goalKg});
    const next = cps.next;

    // find day index of reaching goal (if within horizon)
    let dayHit = null;
    for(let i=0;i<weightsKgByDay.length;i++){
      if(weightsKgByDay[i] <= goalKg){ dayHit = i; break; }
    }

    const endKg = weightsKgByDay[weightsKgByDay.length-1];
    const endVal = (units==="imperial") ? kgToLb(endKg) : endKg;

    let msg = `<div style="font-weight:900;">Milestones</div>`;
    msg += `<div class="tiny">Start <b>${round(startVal,1)} ${unitLabel}</b> → Goal <b>${round(goalVal,1)} ${unitLabel}</b>. Projected end <b>${round(endVal,1)} ${unitLabel}</b>.</div>`;

    if(next != null){
      msg += `<div class="tiny" style="margin-top:8px;">Next checkpoint: <b>${round(next,1)} ${unitLabel}</b></div>`;
    }

    if(dayHit != null){
      msg += `<div class="tiny" style="margin-top:6px;">Goal reached in projection: ~<b>${dayHit}</b> days.</div>`;
    } else {
      msg += `<div class="tiny" style="margin-top:6px;">Goal not reached within current horizon—extend the horizon or increase deficit.</div>`;
    }

    box.innerHTML = msg;
    box.style.display = "";
  }

  // ---------- Logs ----------
  function getCurrentDisplayWeight(units, kg){
    return units === "imperial" ? kgToLb(kg) : kg;
  }

  function loadLogs(){
    const s = loadStore();
    return Array.isArray(s.logs) ? s.logs : [];
  }
  function saveLogs(logs){
    const s = loadStore();
    s.logs = logs;
    saveStore(s);
  }

  function renderLogs(){
    const logs = loadLogs();
    const box = $("logsView");
    if(!logs.length){
      box.textContent = "No logs yet.";
      return;
    }
    // show last 10
    const last = logs.slice(-10).reverse();
    box.innerHTML = last.map(l => `• <b>${l.date}</b> — ${l.weight} ${l.unit}`).join("<br>");
  }

  function addTodayLog({units, weightVal}){
    const logs = loadLogs();
    const date = todayISO();
    const unit = units==="imperial" ? "lb" : "kg";
    const entry = {date, weight: round(weightVal,1), unit};

    // replace if same date exists
    const idx = logs.findIndex(x => x.date === date && x.unit === unit);
    if(idx >= 0) logs[idx] = entry;
    else logs.push(entry);

    saveLogs(logs);
    renderLogs();
  }

  // ---------- Diet checklist ----------
  const DIET_PRESETS = {
    none: [],
    lowfodmap: [
      {id:"lf1", title:"2–6 week strict phase", meta:"Then reintroduce one group at a time."},
      {id:"lf2", title:"Avoid high FODMAP triggers", meta:"Common: onion/garlic, wheat in large amounts, certain legumes, some fruits."},
      {id:"lf3", title:"Choose simple proteins", meta:"Chicken, fish, eggs; watch sauces."},
      {id:"lf4", title:"Low FODMAP carbs", meta:"Rice, oats, potatoes; portion matters."},
      {id:"lf5", title:"Track symptoms + reintroductions", meta:"One change at a time."},
      {id:"lf6", title:"Consider dietitian guidance", meta:"Especially if symptoms persist."}
    ],
    diabetes: [
      {id:"db1", title:"Prioritize protein + fiber per meal", meta:"Helps blunt glucose spikes."},
      {id:"db2", title:"Carb consistency", meta:"Similar carbs each day if possible."},
      {id:"db3", title:"Choose low-glycemic carbs", meta:"Beans, oats, whole grains; portions matter."},
      {id:"db4", title:"Limit sugary drinks", meta:"Swap for water / diet options."},
      {id:"db5", title:"Walk 10–20 min after meals", meta:"Often improves post-meal glucose."},
      {id:"db6", title:"Have a hypo plan (if on meds)", meta:"Discuss with clinician."}
    ],
    heart: [
      {id:"ht1", title:"Aim for mostly unsaturated fats", meta:"Olive oil, nuts, fatty fish (as tolerated)."},
      {id:"ht2", title:"Limit ultra-processed foods", meta:"Sodium + added sugars add up."},
      {id:"ht3", title:"Fiber target", meta:"25–38g/day (build gradually)."},
      {id:"ht4", title:"Veg/fruit daily", meta:"Whatever you tolerate consistently."},
      {id:"ht5", title:"Protein balance", meta:"Lean proteins; watch fried foods."},
      {id:"ht6", title:"Sleep + stress basics", meta:"Cardio + resting HR improve with recovery."}
    ]
  };

  const DIET_KEY = "bp_diet_v1";
  function loadDietState(){
    try{ return JSON.parse(localStorage.getItem(DIET_KEY) || "{}"); }catch(e){ return {}; }
  }
  function saveDietState(state){
    localStorage.setItem(DIET_KEY, JSON.stringify(state));
  }

  function renderDietChecklist(){
    const preset = $("dietPreset").value;
    const show = $("dietShow").value === "yes";
    const wrap = $("dietChecklist");
    wrap.innerHTML = "";
    wrap.style.display = show ? "" : "none";
    if(!show) return;

    const items = DIET_PRESETS[preset] || [];
    const state = loadDietState();
    state[preset] = state[preset] || {};
    saveDietState(state);

    for(const it of items){
      const div = document.createElement("div");
      div.className = "checkItem";
      const checked = !!(state[preset] && state[preset][it.id]);

      div.innerHTML = `
        <input type="checkbox" ${checked ? "checked":""} data-id="${it.id}" />
        <div>
          <div style="font-weight:900;">${it.title}</div>
          <div class="meta">${it.meta || ""}</div>
        </div>
      `;
      wrap.appendChild(div);
    }

    wrap.querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.addEventListener("change", () => {
        const id = cb.getAttribute("data-id");
        const st = loadDietState();
        st[preset] = st[preset] || {};
        st[preset][id] = cb.checked;
        saveDietState(st);
      });
    });
  }

  // ---------- Share ----------
  function shareSummary(text){
    if(navigator.share){
      navigator.share({ title: "Body Projection", text }).catch(()=>{});
      return;
    }
    // fallback copy
    navigator.clipboard?.writeText(text).then(()=>{
      alert("Copied summary to clipboard.");
    }).catch(()=>{
      alert(text);
    });
  }

  // ---------- Main calculate ----------
  function calculate(){
    const x = getInputs();
    const errs = validate(x);
    if(errs.length){
      renderNotices([{type:"bad", msg: errs.join(" ")}]);
      $("heroMsg").textContent = "—";
      $("checkpointBox").style.display = "none";
      return;
    }

    const bmr = mifflinStJeor({sex:x.sex, kg:x.kg, cm:x.cm, age:x.age});
    const tdee = bmr * x.activity;

    // base deficit depending on mode
    let baseDef = x.deficit;
    let notices = [];

    if(x.mode === "calories"){
      baseDef = Math.max(0, tdee - x.intake);
      if(x.intake > tdee){
        notices.push({type:"warn", msg:"Your intake is above estimated TDEE—projection will show maintenance/gain unless activity changes. Deficit is capped at 0 here."});
      }
    }

    // goal weight to kg when relevant
    let goalKg = null;
    if(x.mode === "date" || x.mode === "goaleta"){
      goalKg = (x.units==="imperial") ? lbToKg(x.goalWeight) : x.goalWeight;
    }

    // Target Date mode: compute required daily deficit to hit goal by date + set horizon
    let horizonDays = x.days;
    if(x.mode === "date"){
      const now = new Date();
      const gd = new Date(x.goalDate + "T00:00:00");
      const diffMs = gd - now;
      const daysToGoal = Math.max(1, Math.ceil(diffMs / (1000*60*60*24)));
      horizonDays = clamp(daysToGoal, 7, 365);

      const diffKg = x.kg - goalKg;
      if(diffKg <= 0){
        baseDef = 0;
        notices.push({type:"warn", msg:"Your goal is at/above your current weight. Required deficit is 0 (maintenance)."});
      } else {
        const diffLb = kgToLb(diffKg);
        const totalKcal = diffLb * x.kcalPerLb;
        // IMPORTANT: this is the planned deficit; adherence is applied later
        baseDef = totalKcal / daysToGoal;
      }
      notices.push({type:"warn", msg:`Target Date mode: horizon set to ${horizonDays} days to match your goal date.`});
    }

    // Apply adherence + maintenance days schedule inside the daily model
    const weightsKgByDay = projectDailyWeightsKg({
      startKg: x.kg,
      baseDef,
      adherence: x.adherence,
      days: horizonDays,
      adapt: x.adapt,
      kcalPerLb: x.kcalPerLb,
      maintDays: x.maintDays,
      maintPattern: x.maintPattern
    });

    // compute effective average deficit (rough) for display:
    // average kg drop per day -> kcal/day equivalent
    const startKg = weightsKgByDay[0];
    const endKg = weightsKgByDay[weightsKgByDay.length-1];
    const totalLossKg = startKg - endKg;
    const totalLossLb = kgToLb(totalLossKg);
    const totalKcal = totalLossLb * x.kcalPerLb;
    const effAvgDef = totalKcal / horizonDays;

    const rateLbPerWeek = (effAvgDef * 7) / x.kcalPerLb;
    const rateKgPerWeek = lbToKg(rateLbPerWeek);

    $("bmr").textContent  = String(Math.round(bmr));
    $("tdee").textContent = String(Math.round(tdee));
    $("effDef").textContent = String(Math.round(effAvgDef));
    $("rate").textContent = (x.units==="imperial")
      ? `${round(rateLbPerWeek, 2)} lb/wk`
      : `${round(rateKgPerWeek, 2)} kg/wk`;

    // hero end weight
    const endVal = (x.units==="imperial") ? kgToLb(endKg) : endKg;
    const unitLabel = (x.units==="imperial") ? "lb" : "kg";
    $("heroMsg").textContent = `${round(endVal, 1)} ${unitLabel}`;

    // goal line for chart
    let goalLine = null;
    if(goalKg != null){
      goalLine = (x.units==="imperial") ? x.goalWeight : x.goalWeight;
    }

    // warnings
    const projectedIntake = tdee - baseDef;
    if(projectedIntake < 1200){
      notices.push({type:"bad", msg:"Projected intake is below ~1200 kcal/day (rough estimate). That’s often too aggressive for many people."});
    } else if(projectedIntake < 1500){
      notices.push({type:"warn", msg:"Projected intake is quite low. If energy/sleep/training dips, reduce deficit."});
    }
    if(rateLbPerWeek > 2.5){
      notices.push({type:"bad", msg:"Projected loss rate > ~2.5 lb/week. Very aggressive and often not sustainable."});
    } else if(rateLbPerWeek > 2.0){
      notices.push({type:"warn", msg:"Projected loss rate > ~2 lb/week. Aggressive—monitor recovery."});
    }
    if(baseDef > tdee * 0.35){
      notices.push({type:"warn", msg:"Deficit > 35% of maintenance. Many people struggle to adhere long-term."});
    }
    if(x.maintDays > 0){
      notices.push({type:"warn", msg:`Maintenance days enabled: ${x.maintDays}/week (${x.maintPattern}). This improves sustainability but slows the weekly average.`});
    }
    notices.push({type:"warn", msg:"Reality check: water/glycogen can mask fat loss week-to-week. Focus on trend."});

    // Goal ETA mode: estimate ETA from the projected curve
    if(x.mode === "goaleta"){
      if(goalKg != null){
        if(x.kg <= goalKg){
          notices.unshift({type:"warn", msg:"You’re already at or below your goal weight based on current input."});
        } else {
          let hitDay = null;
          for(let i=0;i<weightsKgByDay.length;i++){
            if(weightsKgByDay[i] <= goalKg){ hitDay = i; break; }
          }
          if(hitDay == null){
            notices.unshift({type:"warn", msg:"Goal not reached within this horizon—extend horizon or increase deficit."});
          } else {
            const eta = new Date();
            eta.setDate(eta.getDate() + hitDay);
            notices.unshift({type:"warn", msg:`Goal ETA: ~${hitDay} days (around ${eta.toISOString().slice(0,10)}) using your plan + maintenance schedule.`});
          }
        }
      }
    }

    renderNotices(notices);
    drawChart(weightsKgByDay, x.units, goalLine);
    renderTable(weightsKgByDay, x.units);

    // checkpoints (only when goal exists and is lower)
    if(goalKg != null){
      updateCheckpointBox({units:x.units, startKg:x.kg, goalKg, weightsKgByDay});
    } else {
      $("checkpointBox").style.display = "none";
    }

    // persist main settings
    const s = loadStore();
    s.inputs = {
      units:x.units, sex:x.sex, age:x.age, activity:x.activity, mode:x.mode,
      days:x.days, adapt:x.adapt, kcalPerLb:x.kcalPerLb,
      adherence: $("adherence").value,
      maintDays: $("maintDays").value,
      maintPattern: $("maintPattern").value,
      cm:x.cm, kg:x.kg,
      deficit:x.deficit, intake:x.intake,
      goalWeight:x.goalWeight, goalDate:x.goalDate
    };
    saveStore(s);
  }

  function resetAll(){
    localStorage.removeItem(STORE_KEY);
    // keep diet checklist state separate
    location.reload();
  }

  function loadSaved(){
    const s = loadStore();
    if(!s.inputs) return;

    const i = s.inputs;

    $("units").value = i.units ?? "imperial";
    setUnitUI();

    $("sex").value = i.sex ?? "male";
    $("age").value = i.age ?? 33;
    $("activity").value = String(i.activity ?? 1.55);

    $("mode").value = i.mode ?? "deficit";
    setModeUI();

    $("days").value = i.days ?? 56;
    setHorizonLabels();

    $("adapt").value = String(i.adapt ?? 0);
    $("kcalPerLb").value = String(i.kcalPerLb ?? 3500);

    $("adherence").value = i.adherence ?? 100;
    setAdhLabel();

    $("maintDays").value = i.maintDays ?? "0";
    $("maintPattern").value = i.maintPattern ?? "weekend";

    $("deficit").value = i.deficit ?? 500;
    $("intake").value = i.intake ?? 2000;

    $("goalWeight").value = i.goalWeight ?? 160;
    $("goalDate").value = i.goalDate ?? "";

    if(!$("goalDate").value){
      const d = new Date();
      d.setDate(d.getDate()+56);
      $("goalDate").value = d.toISOString().slice(0,10);
    }

    if($("units").value === "metric"){
      $("cm").value = round(i.cm ?? 175, 0);
      $("kg").value = round(i.kg ?? 76.7, 1);
    } else {
      const totalIn = cmToIn(i.cm ?? 175);
      const ft = Math.floor(totalIn/12);
      const inch = Math.round(totalIn - ft*12);
      $("ft").value = ft;
      $("inch").value = Math.min(11, Math.max(0, inch));
      $("lb").value = round(kgToLb(i.kg ?? 76.7), 1);
    }
  }

  // ---------- Events ----------
  $("mode").addEventListener("change", () => { setModeUI(); calculate(); });

  $("units").addEventListener("change", () => {
    setUnitUI();
    const u = $("units").value;
    if(u === "metric"){
      const ft = Number($("ft").value);
      const inch = Number($("inch").value);
      const lb = Number($("lb").value);
      $("cm").value = round(inToCm(ft*12 + inch), 0);
      $("kg").value = round(lbToKg(lb), 1);
      // convert goal weight too if visible
      if($("goalWeight").value) $("goalWeight").value = round(lbToKg(Number($("goalWeight").value)), 1);
    } else {
      const cm = Number($("cm").value);
      const kg = Number($("kg").value);
      const totalIn = cmToIn(cm);
      const ft = Math.floor(totalIn/12);
      const inch = Math.round(totalIn - ft*12);
      $("ft").value = ft;
      $("inch").value = Math.min(11, Math.max(0, inch));
      $("lb").value = round(kgToLb(kg), 1);
      if($("goalWeight").value) $("goalWeight").value = round(kgToLb(Number($("goalWeight").value)), 1);
    }
    calculate();
  });

  $("days").addEventListener("input", () => { setHorizonLabels(); calculate(); });
  document.querySelectorAll(".preset").forEach(btn=>{
    btn.addEventListener("click", () => {
      $("days").value = btn.dataset.days;
      setHorizonLabels();
      calculate();
    });
  });

  $("adherence").addEventListener("input", () => { setAdhLabel(); calculate(); });

  ["sex","age","activity","adapt","kcalPerLb","ft","inch","lb","cm","kg","deficit","intake","goalWeight","goalDate","maintDays","maintPattern"]
    .forEach(id => $(id).addEventListener("input", () => calculate()));

  $("calc").addEventListener("click", calculate);
  $("reset").addEventListener("click", resetAll);

  $("logToday").addEventListener("click", () => {
    const x = getInputs();
    const w = getCurrentDisplayWeight(x.units, x.kg);
    addTodayLog({units:x.units, weightVal:w});
    alert("Logged today ✅");
  });

  $("clearLogs").addEventListener("click", () => {
    if(confirm("Clear all logs?")){ saveLogs([]); renderLogs(); }
  });

  $("share").addEventListener("click", () => {
    const x = getInputs();
    const u = x.units==="imperial" ? "lb" : "kg";
    const end = $("heroMsg").textContent;
    const text =
`Body Projection
Mode: ${$("heroMode").textContent}
Horizon: ${$("heroHorizon").textContent}
Adherence: ${$("heroAdh").textContent}
BMR: ${$("bmr").textContent} kcal/day
TDEE: ${$("tdee").textContent} kcal/day
Effective deficit: ${$("effDef").textContent} kcal/day
Rate: ${$("rate").textContent}
Projected end: ${end}
(Estimates only)`;
    shareSummary(text);
  });

  // diet
  $("dietPreset").addEventListener("change", renderDietChecklist);
  $("dietShow").addEventListener("change", renderDietChecklist);

  // ---------- Init ----------
  if(!$("goalDate").value){
    const d = new Date();
    d.setDate(d.getDate()+56);
    $("goalDate").value = d.toISOString().slice(0,10);
  }

  loadSaved();
  setUnitUI();
  setModeUI();
  setHorizonLabels();
  setAdhLabel();

  renderLogs();
  renderDietChecklist();
  calculate();
})();
</script>
</body>
</html>