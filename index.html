<!doctype html>
<html lang="en">
<head>
  <link rel="apple-touch-icon" href="./calcurve-icon.png">
<link rel="icon" type="image/png" href="./calcurve-icon.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <title>CalCurve</title>

  <!-- PWA / iPhone -->
  <meta name="application-name" content="CalCurve">
  <meta name="apple-mobile-web-app-title" content="CalCurve">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0f10" />

  <link rel="manifest" href="./manifest.webmanifest">

  <!-- Minimal chart favicon (SVG data URI) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='26' fill='%230b0f10'/%3E%3Cpath d='M26 84 L49 66 L70 74 L102 42' fill='none' stroke='%2322c55e' stroke-width='10' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='102' cy='42' r='7' fill='%2322c55e'/%3E%3C/svg%3E">

  <!-- Optional later: if you add PNGs in /icons -->
  <!-- <link rel="apple-touch-icon" href="icons/apple-touch-icon.png"> -->

  <style>
    :root{
      color-scheme: dark;

      --bg0:#07090a;
      --bg1:#0b0f10;
      --bg2:#0d1414;

      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.04);
      --border: rgba(120,255,190,.14);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --accent:#22c55e;
      --accent2:#10b981;

      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 18px 46px rgba(0,0,0,.40);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 0%, rgba(34,197,94,.16), transparent 58%),
        radial-gradient(900px 600px at 85% 10%, rgba(16,185,129,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
      padding: 18px;
    }

    .wrap{ max-width: 1020px; margin:0 auto; }

    .hero{
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 14px 14px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute;
      inset:-40px -40px auto auto;
      width:320px; height:320px;
      background: radial-gradient(circle at 30% 30%, rgba(34,197,94,.22), transparent 62%);
      transform: rotate(12deg);
      pointer-events:none;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      position:relative;
      z-index:1;
    }
    .logo{
      width:34px; height:34px;
      border-radius: 10px;
      border:1px solid rgba(120,255,190,.18);
      background: rgba(255,255,255,.04);
      display:grid; place-items:center;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .logo svg{ width:22px; height:22px; }

    h1{ margin:0; font-size: 20px; letter-spacing:.2px; }
    .subtitle{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
      max-width: 82ch;
      position: relative;
      z-index: 1;
    }

    .bigline{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .chip{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .chip b{ color: var(--text); }

    .card{
      margin-top: 14px;
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      background: linear-gradient(180deg, var(--card), var(--card2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    @media (max-width: 820px){ .grid{ grid-template-columns: 1fr; } }

    label{ display:block; font-size: 12px; color: var(--muted); margin: 0 0 6px; }
    input, select{
      width:100%;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(120,255,190,.18);
      background: rgba(255,255,255,.05);
      font-size: 16px;
      color: var(--text);
      outline: none;
    }
    input:focus, select:focus{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 4px rgba(34,197,94,.14);
    }

    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }

    .btnrow{ display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap; }
    button{
      border:none;
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 900;
      cursor: pointer;
      color: rgba(255,255,255,.94);
    }
    .primary{
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      box-shadow: 0 10px 22px rgba(34,197,94,.18);
    }
    .secondary{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(120,255,190,.16);
      font-weight: 800;
    }

    .tiny{ font-size: 11px; color: var(--muted); margin-top: 6px; line-height:1.35; }
    .muted{ font-size: 12px; color: var(--muted); line-height:1.4; }

    .results{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 900px){ .results{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 520px){ .results{ grid-template-columns: 1fr; } }

    .pill{
      border:1px solid rgba(120,255,190,.14);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 12px;
    }
    .pill .k{ font-size: 12px; color: var(--muted); }
    .pill .v{ font-size: 18px; font-weight: 1000; margin-top: 5px; letter-spacing:.2px; }

    .notice{
      margin-top: 10px;
      border-left: 4px solid var(--warn);
      background: rgba(245,158,11,.10);
      border-radius: 12px;
      padding: 10px 12px;
      color: rgba(255,255,255,.90);
      font-size: 13px;
      line-height:1.35;
    }
    .notice.bad{
      border-left-color: var(--bad);
      background: rgba(239,68,68,.10);
    }

    .presetRow{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .preset{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(120,255,190,.16);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,.88);
    }

    canvas{
      width:100%;
      height: 260px;
      border-radius: 16px;
      border: 1px solid rgba(120,255,190,.14);
      background: rgba(255,255,255,.03);
    }

    table{ width:100%; border-collapse: collapse; margin-top: 10px; overflow:hidden; border-radius: 16px; }
    th, td{ text-align:left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,.07); font-size: 14px; }
    th{ font-size: 12px; color: var(--muted); }
    tr:last-child td{ border-bottom: none; }

    .hr{ height:1px; background: rgba(255,255,255,.08); margin: 10px 0; border-radius: 999px; }

    /* Diet */
    .dietHeader{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .dietNote{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      max-width: 80ch;
    }
    .dietGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 820px){ .dietGrid{ grid-template-columns: 1fr; } }

    .dietCol{
      border: 1px solid rgba(120,255,190,.14);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .dietCol .head{
      padding: 10px 12px;
      font-weight: 1000;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      background: rgba(255,255,255,.04);
      border-bottom: 1px solid rgba(255,255,255,.07);
    }
    .dietCol .head .tag{
      font-size: 11px;
      color: rgba(255,255,255,.72);
      border:1px solid rgba(120,255,190,.14);
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(34,197,94,.08);
      white-space: nowrap;
    }
    .dietList{ padding: 6px 10px 10px; }
    .dietItem{
      padding: 10px 8px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .dietItem:last-child{ border-bottom:none; }
    .dietItem .t{ font-weight: 900; }
    .dietItem .m{ margin-top:4px; font-size: 12px; color: var(--muted); line-height:1.25; }
    .dietItem .p{
      margin-top:6px;
      font-size: 12px;
      color: rgba(255,255,255,.86);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pillMini{
      border:1px solid rgba(120,255,190,.14);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      padding: 4px 8px;
      font-weight: 800;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 16 L9 11 L13 14 L20 7" stroke="rgba(34,197,94,.95)" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="20" cy="7" r="1.7" fill="rgba(34,197,94,.95)"/>
          </svg>
        </div>
        <h1>CalCurve</h1>
      </div>

      <div class="subtitle">
        Estimates only. Scale weight can swing from water/glycogen. Diet lists are starter guidance, not a prescription—especially if you have GI conditions, diabetes meds, or other medical constraints.
      </div>
      <div class="bigline">
        <div class="chip">Mode: <b id="heroMode">Daily Deficit</b></div>
        <div class="chip">Horizon: <b id="heroHorizon">56 days</b></div>
        <div class="chip">Adherence: <b id="heroAdh">100%</b></div>
        <div class="chip">Projected end: <b id="heroMsg">—</b></div>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label>Mode</label>
          <select id="mode">
            <option value="deficit" selected>Daily Deficit</option>
            <option value="calories">Target Calories (intake)</option>
            <option value="date">Target Date (goal weight by date)</option>
            <option value="goaleta">Goal Weight ETA (when will I hit it?)</option>
          </select>
          <div class="tiny">Goal modes use your Goal Weight (and Date) to compute required deficit or ETA.</div>
        </div>

        <div>
          <label>Units</label>
          <select id="units">
            <option value="imperial" selected>Imperial (ft/in, lb)</option>
            <option value="metric">Metric (cm, kg)</option>
          </select>
        </div>

        <div>
          <label>Sex</label>
          <select id="sex">
            <option value="male" selected>Male</option>
            <option value="female">Female</option>
          </select>
        </div>

        <div>
          <label>Age</label>
          <input id="age" type="number" inputmode="numeric" min="10" max="100" value="33" />
        </div>

        <div id="heightImperial">
          <label>Height</label>
          <div class="row">
            <input id="ft" type="number" inputmode="numeric" min="3" max="8" value="5" />
            <input id="inch" type="number" inputmode="numeric" min="0" max="11" value="9" />
          </div>
          <div class="tiny">Feet / Inches</div>
        </div>

        <div id="heightMetric" style="display:none;">
          <label>Height (cm)</label>
          <input id="cm" type="number" inputmode="decimal" min="120" max="230" value="175" />
        </div>

        <div id="weightImperial">
          <label>Current weight (lb)</label>
          <input id="lb" type="number" inputmode="decimal" min="70" max="600" value="169" />
        </div>

        <div id="weightMetric" style="display:none;">
          <label>Current weight (kg)</label>
          <input id="kg" type="number" inputmode="decimal" min="30" max="300" value="76.7" />
        </div>

        <div>
          <label>Activity level</label>
          <select id="activity">
            <option value="1.2">Sedentary (little exercise)</option>
            <option value="1.375">Light (1–3 days/wk)</option>
            <option value="1.55" selected>Moderate (3–5 days/wk)</option>
            <option value="1.725">Very active (6–7 days/wk)</option>
            <option value="1.9">Athlete / extra active</option>
          </select>
        </div>

        <div>
          <label>Adherence</label>
          <input id="adherence" type="range" min="70" max="100" value="100" />
          <div class="tiny">Assumes you hit your plan <b id="adhLabel">100%</b> of the time.</div>
        </div>

        <div>
          <label>Horizon (days)</label>
          <input id="days" type="range" min="7" max="365" value="56" />
          <div class="tiny">Projecting <b id="daysLabel">56</b> days (~<b id="weeksLabel">8</b> weeks)</div>
          <div class="presetRow">
            <button class="preset" type="button" data-days="7">7</button>
            <button class="preset" type="button" data-days="14">14</button>
            <button class="preset" type="button" data-days="30">30</button>
            <button class="preset" type="button" data-days="60">60</button>
            <button class="preset" type="button" data-days="90">90</button>
          </div>
        </div>

        <div>
          <label>Maintenance / refeed days</label>
          <select id="maintDays">
            <option value="0" selected>0 days/week (straight cut)</option>
            <option value="1">1 day/week (maintenance)</option>
            <option value="2">2 days/week (maintenance)</option>
          </select>
          <div class="tiny">These days assume ~0 deficit (maintenance).</div>
        </div>

        <div>
          <label>Maintenance days occur on</label>
          <select id="maintPattern">
            <option value="weekend" selected>Weekend (Sat/Sun first)</option>
            <option value="even">Evenly spaced</option>
          </select>
        </div>

        <div>
          <label>Adaptation (optional)</label>
          <select id="adapt">
            <option value="0" selected>None (simple)</option>
            <option value="0.10">Mild (10% slower over time)</option>
            <option value="0.20">Moderate (20% slower over time)</option>
          </select>
        </div>

        <div>
          <label>Energy density</label>
          <select id="kcalPerLb">
            <option value="3500" selected>3,500 kcal per lb (standard)</option>
            <option value="3200">3,200 kcal per lb (slightly faster)</option>
            <option value="3700">3,700 kcal per lb (slightly slower)</option>
          </select>
        </div>

        <!-- Mode-specific inputs -->
        <div id="deficitBox">
          <label>Daily calorie deficit</label>
          <input id="deficit" type="number" inputmode="numeric" min="0" max="3000" value="500" />
          <div class="tiny">Rough rule: 500/day ≈ ~1 lb/week (varies).</div>
        </div>

        <div id="caloriesBox" style="display:none;">
          <label>Target calories (intake)</label>
          <input id="intake" type="number" inputmode="numeric" min="800" max="8000" value="2000" />
          <div class="tiny">We compute deficit = TDEE − intake (capped at 0).</div>
        </div>

        <div id="goalBox" style="display:none;">
          <label>Goal weight</label>
          <input id="goalWeight" type="number" inputmode="decimal" min="20" max="600" value="160" />
          <div class="tiny">Use lb if Imperial, kg if Metric.</div>
        </div>

        <div id="dateBox" style="display:none;">
          <label>Goal date</label>
          <input id="goalDate" type="date" />
          <div class="tiny">Target Date mode computes the required deficit to hit the goal by the date.</div>
        </div>
      </div>

      <div class="btnrow">
        <button class="primary" id="calc" type="button">Calculate</button>
        <button class="secondary" id="reset" type="button">Reset</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        BMR: Mifflin–St Jeor. TDEE: activity multiplier. Not medical advice.
      </div>
    </div>

    <div class="card">
      <div class="results">
        <div class="pill">
          <div class="k">Estimated BMR</div>
          <div class="v" id="bmr">—</div>
          <div class="tiny">kcal/day</div>
        </div>
        <div class="pill">
          <div class="k">Estimated TDEE</div>
          <div class="v" id="tdee">—</div>
          <div class="tiny">kcal/day (maintenance)</div>
        </div>
        <div class="pill">
          <div class="k">Effective deficit</div>
          <div class="v" id="effDef">—</div>
          <div class="tiny">avg kcal/day after adherence + maintenance days</div>
        </div>
        <div class="pill">
          <div class="k">Expected rate</div>
          <div class="v" id="rate">—</div>
          <div class="tiny">per week (estimate)</div>
        </div>
      </div>

      <div id="notices"></div>

      <div class="hr"></div>

      <canvas id="chart" width="980" height="380"></canvas>
      <div class="tiny" style="margin-top:6px;">Chart is projected scale weight by week. If goal mode is on, the goal line is shown.</div>

      <table>
        <thead>
          <tr>
            <th>Week</th>
            <th>Projected weight</th>
            <th>Change</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="card">
      <div class="dietHeader">
        <div>
          <div style="font-weight:1000; letter-spacing:.2px;">Diet guide (foods + portions)</div>
          <div class="dietNote">
            Starter guidance only. For Low FODMAP, limits vary by food + portion (“stacking” matters). For diabetes/meds, follow clinician guidance.
          </div>
        </div>
        <div style="min-width: 260px;">
          <label>Preset</label>
          <select id="dietPreset">
            <option value="none" selected>None</option>
            <option value="lowfodmap">Low FODMAP (starter)</option>
            <option value="diabetes">Diabetes-friendly (starter)</option>
            <option value="heart">Heart-healthy (starter)</option>
          </select>
        </div>
      </div>

      <div id="dietArea" class="dietGrid" style="display:none;">
        <div class="dietCol">
          <div class="head">
            <span>✅ Generally OK</span>
            <span class="tag" id="okTag">Portions</span>
          </div>
          <div class="dietList" id="dietOK"></div>
        </div>

        <div class="dietCol">
          <div class="head">
            <span>⛔ Avoid / Limit</span>
            <span class="tag" id="noTag">Triggers</span>
          </div>
          <div class="dietList" id="dietNO"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  function round(n, d=0){ const p=Math.pow(10,d); return Math.round(n*p)/p; }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function lbToKg(lb){ return lb * 0.45359237; }
  function kgToLb(kg){ return kg / 0.45359237; }
  function inToCm(inches){ return inches * 2.54; }
  function cmToIn(cm){ return cm / 2.54; }

  function mifflinStJeor({sex, kg, cm, age}){
    const s = (sex === "male") ? 5 : -161;
    return (10*kg) + (6.25*cm) - (5*age) + s;
  }

  function setModeUI(){
    const mode = $("mode").value;
    $("deficitBox").style.display = (mode==="deficit") ? "" : "none";
    $("caloriesBox").style.display = (mode==="calories") ? "" : "none";
    $("goalBox").style.display = (mode==="date" || mode==="goaleta") ? "" : "none";
    $("dateBox").style.display = (mode==="date") ? "" : "none";
    $("heroMode").textContent =
      mode==="deficit" ? "Daily Deficit" :
      mode==="calories" ? "Target Calories" :
      mode==="date" ? "Target Date" : "Goal Weight ETA";
  }

  function setUnitUI(){
    const u = $("units").value;
    $("heightImperial").style.display = (u==="imperial") ? "" : "none";
    $("weightImperial").style.display = (u==="imperial") ? "" : "none";
    $("heightMetric").style.display   = (u==="metric") ? "" : "none";
    $("weightMetric").style.display   = (u==="metric") ? "" : "none";
  }

  function setHorizonLabels(){
    const d = Number($("days").value);
    $("daysLabel").textContent = d;
    $("weeksLabel").textContent = round(d/7, 1);
    $("heroHorizon").textContent = `${d} days`;
  }

  function setAdhLabel(){
    const a = Number($("adherence").value);
    $("adhLabel").textContent = `${a}%`;
    $("heroAdh").textContent = `${a}%`;
  }

  function makeMaintenanceSet(maintDays, pattern){
    const set = new Set();
    if(maintDays <= 0) return set;
    if(pattern === "weekend"){
      if(maintDays >= 1) set.add(6); // Sat
      if(maintDays >= 2) set.add(0); // Sun
      return set;
    }
    if(maintDays === 1) { set.add(3); return set; } // Wed
    if(maintDays === 2) { set.add(3); set.add(0); return set; }
    return set;
  }

  function projectDailyWeightsKg({startKg, baseDef, adherence, days, adapt, kcalPerLb, maintDays, maintPattern}){
    const arr = [];
    let kg = startKg;
    arr.push(kg);

    const maintSet = makeMaintenanceSet(maintDays, maintPattern);
    const startDate = new Date();

    for(let d=1; d<=days; d++){
      const progress = d / days;
      const adaptFactor = 1 - (adapt * progress);

      const date = new Date(startDate.getTime());
      date.setDate(startDate.getDate() + (d-1));
      const dow = date.getDay();

      const dayDef = maintSet.has(dow) ? 0 : baseDef;
      const effDef = dayDef * adherence * adaptFactor;

      const lbChange = (effDef / kcalPerLb);
      const kgChange = lbToKg(lbChange);

      kg = Math.max(0, kg - kgChange);
      arr.push(kg);
    }
    return arr;
  }

  function renderTable(weightsKgByDay, units){
    const tbody = $("tbody");
    tbody.innerHTML = "";
    const start = weightsKgByDay[0];
    const totalWeeks = Math.floor((weightsKgByDay.length-1)/7);

    for(let w=0; w<=totalWeeks; w++){
      const idx = Math.min(weightsKgByDay.length-1, w*7);
      const kg = weightsKgByDay[idx];
      const val = (units==="imperial") ? kgToLb(kg) : kg;
      const delta = (units==="imperial") ? kgToLb(kg - start) : (kg - start);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${w}</td>
        <td>${units==="imperial" ? `${round(val,1)} lb` : `${round(val,1)} kg`}</td>
        <td>${(delta>=0?"+":"")}${units==="imperial" ? `${round(delta,1)} lb` : `${round(delta,1)} kg`}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function drawChart(weightsKgByDay, units, goalLine){
    const c = $("chart");
    const ctx = c.getContext("2d");
    const W = c.width, H = c.height;
    ctx.clearRect(0,0,W,H);

    const pts = [];
    for(let i=0;i<weightsKgByDay.length;i+=7) pts.push(weightsKgByDay[i]);
    if(pts[pts.length-1] !== weightsKgByDay[weightsKgByDay.length-1]) pts.push(weightsKgByDay[weightsKgByDay.length-1]);

    const padL=54, padR=18, padT=18, padB=44;
    const vals = pts.map(kg => units==="imperial" ? kgToLb(kg) : kg);
    const min = Math.min(...vals), max = Math.max(...vals);
    const span = Math.max(1e-9, max - min);
    const yMin = min - span*0.12;
    const yMax = max + span*0.12;

    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.fillStyle = "rgba(255,255,255,.55)";
    ctx.font = "12px -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial";

    const ticks = 5;
    for(let i=0;i<=ticks;i++){
      const t=i/ticks;
      const y = padT + (H-padT-padB)*(1-t);
      ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W-padR, y); ctx.stroke();

      const val = yMin + (yMax-yMin)*t;
      const label = Math.round(val);
      ctx.fillText(String(label), 10, y+4);
    }

    if(goalLine != null){
      const gy = padT + (H-padT-padB)*(1 - ((goalLine-yMin)/(yMax-yMin)));
      ctx.setLineDash([6,6]);
      ctx.strokeStyle = "rgba(34,197,94,.70)";
      ctx.beginPath(); ctx.moveTo(padL, gy); ctx.lineTo(W-padR, gy); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = "rgba(34,197,94,.80)";
      ctx.fillText("Goal", padL+6, gy-6);
    }

    const grad = ctx.createLinearGradient(padL, padT, W-padR, H-padB);
    grad.addColorStop(0, "rgba(16,185,129,.95)");
    grad.addColorStop(1, "rgba(34,197,94,.95)");

    ctx.lineWidth = 4;
    ctx.strokeStyle = grad;
    ctx.beginPath();
    for(let i=0;i<vals.length;i++){
      const x = padL + (W-padL-padR) * (i/(vals.length-1));
      const y = padT + (H-padT-padB) * (1 - ((vals[i]-yMin)/(yMax-yMin)));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    ctx.fillStyle = "rgba(34,197,94,.90)";
    for(let i=0;i<vals.length;i++){
      const x = padL + (W-padL-padR) * (i/(vals.length-1));
      const y = padT + (H-padT-padB) * (1 - ((vals[i]-yMin)/(yMax-yMin)));
      ctx.beginPath(); ctx.arc(x,y,3.6,0,Math.PI*2); ctx.fill();
    }
  }

  function renderNotices(list){
    const box = $("notices");
    box.innerHTML = "";
    for(const n of list){
      const div = document.createElement("div");
      div.className = "notice" + (n.type==="bad" ? " bad" : "");
      div.textContent = n.msg;
      box.appendChild(div);
    }
  }

  const DIETS = {
    none: { ok: [], no: [], okTag:"", noTag:"" },
    lowfodmap: {
      okTag: "Conservative starter portions",
      noTag: "Common high-FODMAP triggers",
      ok: [
        { t:"Proteins (plain)", m:"Chicken, fish, eggs, firm tofu (watch sauces).", p:"Portion: palm-sized (25–40g protein)", d:"Daily: as needed" },
        { t:"Rice / oats / potatoes", m:"Usually tolerated; keep portions moderate.", p:"Portion: 1/2–1 cup cooked", d:"Daily: 1–3 servings" },
        { t:"Low-FODMAP veg", m:"Carrots, zucchini, cucumber, bell pepper, spinach (portions matter).", p:"Portion: 1 cup raw / 1/2 cup cooked", d:"Daily: 2–6 servings" },
        { t:"Low-FODMAP fruit", m:"Firm bananas, blueberries, oranges (portion matters).", p:"Portion: ~1 serving", d:"Daily: 1–2 servings" },
        { t:"Lactose-free dairy", m:"Lactose-free milk/yogurt or hard cheeses (many tolerate).", p:"Portion: 1 cup / 1 oz cheese", d:"Daily: 0–2 servings" },
        { t:"Flavor swaps", m:"Use garlic-infused oil, chives, green onion tops.", p:"Portion: to taste", d:"Daily: OK" }
      ],
      no: [
        { t:"Onion / garlic", m:"Very common triggers (even small amounts).", p:"Portion: avoid", d:"Daily: avoid" },
        { t:"Wheat-heavy meals", m:"Bread/pasta in large amounts can trigger symptoms.", p:"Portion: limit", d:"Daily: prefer low-FODMAP swaps" },
        { t:"Many legumes", m:"Beans/lentils often trigger unless portion is very small.", p:"Portion: limit", d:"Daily: avoid early phase" },
        { t:"Certain fruits", m:"Apples, pears, mango (often high).", p:"Portion: avoid early", d:"Daily: avoid" },
        { t:"Sugar alcohols", m:"Sorbitol/mannitol/xylitol often trigger.", p:"Portion: avoid", d:"Daily: avoid" },
        { t:"Milk (lactose)", m:"Regular milk can trigger if lactose sensitive.", p:"Portion: avoid", d:"Daily: avoid" }
      ]
    },
    diabetes: {
      okTag: "Glucose-friendly structure",
      noTag: "Spike risks",
      ok: [
        { t:"Protein with each meal", m:"Helps blunt spikes.", p:"25–40g/meal", d:"Daily: 2–4 meals" },
        { t:"Fiber-forward carbs", m:"Oats, beans (if tolerated), whole grains.", p:"1/2–1 cup cooked", d:"Daily: 1–3 servings" },
        { t:"Non-starchy veg", m:"Big volume, low glycemic impact.", p:"2 cups raw / 1 cup cooked", d:"Daily: 2–6 servings" },
        { t:"Healthy fats", m:"Olive oil, nuts (portion-controlled).", p:"1–2 tbsp / small handful", d:"Daily: 0–2 servings" },
        { t:"Post-meal walk", m:"Often improves post-meal glucose.", p:"10–20 minutes", d:"Daily: 1–3x" }
      ],
      no: [
        { t:"Sugary drinks", m:"Fastest spike.", p:"Avoid", d:"Daily: avoid" },
        { t:"Candy/desserts", m:"High sugar + low satiety.", p:"Limit", d:"Daily: rare" },
        { t:"Huge refined-carb portions", m:"Big white rice/pasta/bread servings.", p:"Limit", d:"Daily: keep small if used" },
        { t:"Carbs without protein", m:"Carbs alone hit harder.", p:"Avoid pattern", d:"Daily: avoid pattern" }
      ]
    },
    heart: {
      okTag: "Heart-healthy pattern",
      noTag: "Limit",
      ok: [
        { t:"Fatty fish", m:"Salmon/sardines (if you like).", p:"3–6 oz", d:"Weekly: 2–3x" },
        { t:"Fiber daily", m:"Veg, oats, legumes (if tolerated).", p:"Build gradually", d:"Daily: aim 25–38g fiber" },
        { t:"Unsaturated fats", m:"Olive oil, avocado, nuts.", p:"1–2 tbsp / small handful", d:"Daily: 0–2 servings" },
        { t:"Lean proteins", m:"Chicken, turkey, low-fat dairy.", p:"Palm-sized", d:"Daily: as needed" }
      ],
      no: [
        { t:"Ultra-processed foods", m:"Often high sodium + low fiber.", p:"Limit", d:"Daily: limit" },
        { t:"High-sodium meals", m:"Restaurant/processed foods stack sodium.", p:"Limit", d:"Daily: limit" },
        { t:"Deep fried / trans fats", m:"Avoid when possible.", p:"Avoid", d:"Daily: avoid" }
      ]
    }
  };

  function renderDiet(){
    const key = $("dietPreset").value;
    const diet = DIETS[key] || DIETS.none;
    const area = $("dietArea");
    const okBox = $("dietOK");
    const noBox = $("dietNO");

    if(key === "none"){
      area.style.display = "none";
      okBox.innerHTML = "";
      noBox.innerHTML = "";
      return;
    }

    $("okTag").textContent = diet.okTag || "Portions";
    $("noTag").textContent = diet.noTag || "Limit";

    okBox.innerHTML = diet.ok.map(it => `
      <div class="dietItem">
        <div class="t">${it.t}</div>
        <div class="m">${it.m}</div>
        <div class="p">
          <span class="pillMini">${it.p}</span>
          <span class="pillMini">${it.d}</span>
        </div>
      </div>
    `).join("");

    noBox.innerHTML = diet.no.map(it => `
      <div class="dietItem">
        <div class="t">${it.t}</div>
        <div class="m">${it.m}</div>
        <div class="p">
          <span class="pillMini">${it.p}</span>
          <span class="pillMini">${it.d}</span>
        </div>
      </div>
    `).join("");

    area.style.display = "";
  }

  function getInputs(){
    const units = $("units").value;
    const sex = $("sex").value;
    const age = Number($("age").value);
    const activity = Number($("activity").value);
    const mode = $("mode").value;

    const days = Number($("days").value);
    const adapt = Number($("adapt").value);
    const kcalPerLb = Number($("kcalPerLb").value);
    const adherence = Number($("adherence").value) / 100;

    const maintDays = Number($("maintDays").value);
    const maintPattern = $("maintPattern").value;

    let cm, kg;
    if(units === "imperial"){
      const ft = Number($("ft").value);
      const inch = Number($("inch").value);
      const lb = Number($("lb").value);
      cm = inToCm((ft*12) + inch);
      kg = lbToKg(lb);
    } else {
      cm = Number($("cm").value);
      kg = Number($("kg").value);
    }

    const deficit = Number($("deficit").value);
    const intake = Number($("intake").value);
    const goalWeight = Number($("goalWeight").value);
    const goalDate = $("goalDate").value;

    return { units, sex, age, activity, mode, days, adapt, kcalPerLb, adherence, maintDays, maintPattern,
             cm, kg, deficit, intake, goalWeight, goalDate };
  }

  function validate(x){
    const errs = [];
    if(!Number.isFinite(x.age) || x.age < 10 || x.age > 100) errs.push("Age looks off.");
    if(!Number.isFinite(x.cm) || x.cm < 120 || x.cm > 230) errs.push("Height looks off.");
    if(!Number.isFinite(x.kg) || x.kg < 30 || x.kg > 300) errs.push("Weight looks off.");
    if(!Number.isFinite(x.activity) || x.activity < 1.1 || x.activity > 2.2) errs.push("Activity looks off.");
    if(!Number.isFinite(x.days) || x.days < 7 || x.days > 365) errs.push("Horizon looks off.");
    if(x.mode==="deficit" && (!Number.isFinite(x.deficit) || x.deficit < 0 || x.deficit > 3000)) errs.push("Deficit looks off.");
    if(x.mode==="calories" && (!Number.isFinite(x.intake) || x.intake < 800 || x.intake > 8000)) errs.push("Intake looks off.");
    if(x.mode==="date" && !x.goalDate) errs.push("Pick a goal date.");
    if(x.mode==="date" && x.goalDate){
      const t = new Date(x.goalDate + "T00:00:00");
      const now = new Date();
      if(t <= now) errs.push("Goal date must be in the future.");
    }
    return errs;
  }

  function calculate(){
    const x = getInputs();
    const errs = validate(x);
    if(errs.length){
      renderNotices([{type:"bad", msg: errs.join(" ")}]);
      $("heroMsg").textContent = "—";
      return;
    }

    const bmr = mifflinStJeor({sex:x.sex, kg:x.kg, cm:x.cm, age:x.age});
    const tdee = bmr * x.activity;

    let baseDef = x.deficit;
    const notices = [];

    if(x.mode === "calories"){
      baseDef = Math.max(0, tdee - x.intake);
      if(x.intake > tdee){
        notices.push({type:"warn", msg:"Your intake is above estimated TDEE — deficit is capped at 0 here (maintenance/gain likely)."});
      }
    }

    let goalKg = null;
    if(x.mode === "date" || x.mode === "goaleta"){
      goalKg = (x.units==="imperial") ? lbToKg(x.goalWeight) : x.goalWeight;
    }

    let horizonDays = x.days;

    if(x.mode === "date" && goalKg != null){
      const now = new Date();
      const gd = new Date(x.goalDate + "T00:00:00");
      const daysToGoal = Math.max(1, Math.ceil((gd - now) / (1000*60*60*24)));
      horizonDays = clamp(daysToGoal, 7, 365);

      const diffKg = x.kg - goalKg;
      if(diffKg <= 0){
        baseDef = 0;
        notices.push({type:"warn", msg:"Goal is at/above current weight. Required deficit is 0 (maintenance)."});
      } else {
        const diffLb = kgToLb(diffKg);
        baseDef = (diffLb * x.kcalPerLb) / daysToGoal;
      }
      notices.push({type:"warn", msg:`Target Date mode: horizon set to ${horizonDays} days to match your goal date.`});
    }

    const weightsKgByDay = projectDailyWeightsKg({
      startKg: x.kg,
      baseDef,
      adherence: x.adherence,
      days: horizonDays,
      adapt: x.adapt,
      kcalPerLb: x.kcalPerLb,
      maintDays: x.maintDays,
      maintPattern: x.maintPattern
    });

    const startKg = weightsKgByDay[0];
    const endKg = weightsKgByDay[weightsKgByDay.length-1];

    const totalLossKg = startKg - endKg;
    const totalLossLb = kgToLb(totalLossKg);
    const totalKcal = totalLossLb * x.kcalPerLb;
    const effAvgDef = totalKcal / horizonDays;

    const rateLbPerWeek = (effAvgDef * 7) / x.kcalPerLb;
    const rateKgPerWeek = lbToKg(rateLbPerWeek);

    $("bmr").textContent = String(Math.round(bmr));
    $("tdee").textContent = String(Math.round(tdee));
    $("effDef").textContent = String(Math.round(effAvgDef));
    $("rate").textContent = (x.units==="imperial")
      ? `${round(rateLbPerWeek, 2)} lb/wk`
      : `${round(rateKgPerWeek, 2)} kg/wk`;

    const endVal = (x.units==="imperial") ? kgToLb(endKg) : endKg;
    const unitLabel = (x.units==="imperial") ? "lb" : "kg";
    $("heroMsg").textContent = `${round(endVal, 1)} ${unitLabel}`;

    let goalLine = null;
    if(goalKg != null){
      goalLine = x.goalWeight; // already in display units
    }

    const projectedIntake = tdee - baseDef;
    if(projectedIntake < 1200) notices.push({type:"bad", msg:"Projected intake is below ~1200 kcal/day (rough estimate). That’s often too aggressive."});
    else if(projectedIntake < 1500) notices.push({type:"warn", msg:"Projected intake is quite low. If energy/sleep/training dips, reduce deficit."});

    if(rateLbPerWeek > 2.5) notices.push({type:"bad", msg:"Projected loss rate > ~2.5 lb/week. Very aggressive and often not sustainable."});
    else if(rateLbPerWeek > 2.0) notices.push({type:"warn", msg:"Projected loss rate > ~2 lb/week. Aggressive—monitor recovery."});

    if(baseDef > tdee * 0.35) notices.push({type:"warn", msg:"Deficit > 35% of maintenance. Many people struggle to adhere long-term."});
    if(x.maintDays > 0) notices.push({type:"warn", msg:`Maintenance days enabled: ${x.maintDays}/week (${x.maintPattern}). Slower weekly average, better sustainability.`});
    notices.push({type:"warn", msg:"Reality check: water/glycogen can mask fat loss week-to-week. Focus on the trend."});

    if(x.mode === "goaleta" && goalKg != null){
      if(x.kg <= goalKg){
        notices.unshift({type:"warn", msg:"You’re already at or below your goal weight based on current input."});
      } else {
        let hitDay = null;
        for(let i=0;i<weightsKgByDay.length;i++){
          if(weightsKgByDay[i] <= goalKg){ hitDay = i; break; }
        }
        if(hitDay == null){
          notices.unshift({type:"warn", msg:"Goal not reached within this horizon—extend horizon or increase deficit."});
        } else {
          const eta = new Date();
          eta.setDate(eta.getDate() + hitDay);
          notices.unshift({type:"warn", msg:`Goal ETA: ~${hitDay} days (around ${eta.toISOString().slice(0,10)}) using your plan + maintenance schedule.`});
        }
      }
    }

    renderNotices(notices);
    drawChart(weightsKgByDay, x.units, goalLine);
    renderTable(weightsKgByDay, x.units);

    // Save preferences (still private on-device)
    localStorage.setItem("calcurve_v1", JSON.stringify({
      units:x.units, sex:x.sex, age:x.age, activity:x.activity, mode:x.mode,
      days:x.days, adapt:x.adapt, kcalPerLb:x.kcalPerLb,
      adherence: $("adherence").value,
      maintDays: $("maintDays").value,
      maintPattern: $("maintPattern").value,
      cm:x.cm, kg:x.kg, deficit:x.deficit, intake:x.intake,
      goalWeight:x.goalWeight, goalDate:x.goalDate,
      dietPreset: $("dietPreset").value
    }));
  }

  function resetAll(){
    localStorage.removeItem("calcurve_v1");
    location.reload();
  }

  function loadSaved(){
    const raw = localStorage.getItem("calcurve_v1");
    if(!raw) return;
    try{
      const s = JSON.parse(raw);

      $("units").value = s.units ?? "imperial";
      setUnitUI();

      $("sex").value = s.sex ?? "male";
      $("age").value = s.age ?? 33;
      $("activity").value = String(s.activity ?? 1.55);

      $("mode").value = s.mode ?? "deficit";
      setModeUI();

      $("days").value = s.days ?? 56;
      setHorizonLabels();

      $("adapt").value = String(s.adapt ?? 0);
      $("kcalPerLb").value = String(s.kcalPerLb ?? 3500);

      $("adherence").value = s.adherence ?? 100;
      setAdhLabel();

      $("maintDays").value = s.maintDays ?? "0";
      $("maintPattern").value = s.maintPattern ?? "weekend";

      $("deficit").value = s.deficit ?? 500;
      $("intake").value = s.intake ?? 2000;

      $("goalWeight").value = s.goalWeight ?? 160;
      $("goalDate").value = s.goalDate ?? "";

      $("dietPreset").value = s.dietPreset ?? "none";

      if(!$("goalDate").value){
        const d = new Date();
        d.setDate(d.getDate()+56);
        $("goalDate").value = d.toISOString().slice(0,10);
      }

      if($("units").value === "metric"){
        $("cm").value = s.cm ?? 175;
        $("kg").value = s.kg ?? 76.7;
      } else {
        const totalIn = cmToIn(s.cm ?? 175);
        const ft = Math.floor(totalIn/12);
        const inch = Math.round(totalIn - ft*12);
        $("ft").value = ft;
        $("inch").value = Math.min(11, Math.max(0, inch));
        $("lb").value = round(kgToLb(s.kg ?? 76.7), 1);
      }
    }catch(e){}
  }

  // events
  $("mode").addEventListener("change", () => { setModeUI(); calculate(); });
  $("units").addEventListener("change", () => { setUnitUI(); calculate(); });

  $("days").addEventListener("input", () => { setHorizonLabels(); calculate(); });
  document.querySelectorAll(".preset").forEach(btn=>{
    btn.addEventListener("click", () => {
      $("days").value = btn.dataset.days;
      setHorizonLabels();
      calculate();
    });
  });

  $("adherence").addEventListener("input", () => { setAdhLabel(); calculate(); });

  ["sex","age","activity","adapt","kcalPerLb","ft","inch","lb","cm","kg","deficit","intake","goalWeight","goalDate","maintDays","maintPattern"]
    .forEach(id => $(id).addEventListener("input", () => calculate()));

  $("dietPreset").addEventListener("change", () => { renderDiet(); });

  $("calc").addEventListener("click", calculate);
  $("reset").addEventListener("click", resetAll);

  // default goal date if empty
  if(!$("goalDate").value){
    const d = new Date();
    d.setDate(d.getDate()+56);
    $("goalDate").value = d.toISOString().slice(0,10);
  }

  loadSaved();
  setModeUI();
  setUnitUI();
  setHorizonLabels();
  setAdhLabel();
  renderDiet();
  calculate();

  // Service worker (offline)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }
})();
</script>
</body>
</html>
